!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Valtio={},e.React)}(this,(function(e,t){"use strict";const n=Symbol(),s=Symbol(),o="a",r="f",a="w";const i=Object.getPrototypeOf,c=new WeakMap,l=e=>e&&(c.has(e)?c.get(e):i(e)===Object.prototype||i(e)===Array.prototype),f=e=>"object"==typeof e&&null!==e,u=e=>{if(Array.isArray(e))return Array.from(e);const t=Object.getOwnPropertyDescriptors(e);return Object.values(t).forEach((e=>{e.configurable=!0})),Object.create(i(e),t)},h=(e,t)=>{const i={[r]:t};let c=!1;const l=(t,n)=>{if(!c){let s=i[o].get(e);if(s||(s={},i[o].set(e,s)),t===a)s[a]=!0;else{let e=s[t];e||(e=new Set,s[t]=e),e.add(n)}}},f={get:(t,n)=>n===s?e:(l("k",n),d(Reflect.get(t,n),i[o],i.c,i.t)),has:(t,s)=>s===n?(c=!0,i[o].delete(e),!0):(l("h",s),Reflect.has(t,s)),getOwnPropertyDescriptor:(e,t)=>(l("o",t),Reflect.getOwnPropertyDescriptor(e,t)),ownKeys:e=>(l(a),Reflect.ownKeys(e))};return t&&(f.set=f.deleteProperty=()=>!1),[f,i]},p=e=>e[s]||e,d=(e,t,n,s)=>{if(!l(e))return e;let r=s&&s.get(e);if(!r){const t=p(e);r=(e=>Object.values(Object.getOwnPropertyDescriptors(e)).some((e=>!e.configurable&&!e.writable)))(t)?[t,u(t)]:[t],null==s||s.set(e,r)}const[a,i]=r;let c=n&&n.get(a);return c&&c[1].f===!!i||(c=h(a,!!i),c[1].p=((e,t)=>new Proxy(e,t))(i||a,c[0]),n&&n.set(a,c)),c[1][o]=t,c[1].c=n,c[1].t=s,c[1].p},y=(e,t,n,s,o=Object.is)=>{if(o(e,t))return!1;if(!f(e)||!f(t))return!0;const r=n.get(p(e));if(!r)return!0;if(s){if(s.get(e)===t)return!1;s.set(e,t)}let i=null;for(const n of r.h||[])if(i=Reflect.has(e,n)!==Reflect.has(t,n),i)return i;if(!0===r[a]){if(i=((e,t)=>{const n=Reflect.ownKeys(e),s=Reflect.ownKeys(t);return n.length!==s.length||n.some(((e,t)=>e!==s[t]))})(e,t),i)return i}else for(const n of r.o||[]){if(i=!!Reflect.getOwnPropertyDescriptor(e,n)!==!!Reflect.getOwnPropertyDescriptor(t,n),i)return i}for(const a of r.k||[])if(i=y(e[a],t[a],n,s,o),i)return i;if(null===i)throw new Error("invalid used");return i},b=(e,t=!0)=>{c.set(e,t)},w=e=>"object"==typeof e&&null!==e,g=(e,t)=>{const n=S.get(e);if((null==n?void 0:n[0])===t)return n[1];const s=Array.isArray(e)?[]:Object.create(Object.getPrototypeOf(e));return b(s,!0),S.set(e,[t,s]),Reflect.ownKeys(e).forEach((t=>{if(Object.getOwnPropertyDescriptor(s,t))return;const n=Reflect.get(e,t),{enumerable:o}=Reflect.getOwnPropertyDescriptor(e,t),r={value:n,enumerable:o,configurable:!0};if(O.has(n))b(n,!1);else if(v.has(n)){const[e,t]=v.get(n);r.value=g(e,t())}Object.defineProperty(s,t,r)})),Object.preventExtensions(s)},v=new WeakMap,O=new WeakSet,S=new WeakMap,m=[1,1],E=new WeakMap;let x=Object.is,j=(e,t)=>new Proxy(e,t),P=e=>w(e)&&!O.has(e)&&(Array.isArray(e)||!(Symbol.iterator in e))&&!(e instanceof WeakMap)&&!(e instanceof WeakSet)&&!(e instanceof Error)&&!(e instanceof Number)&&!(e instanceof Date)&&!(e instanceof String)&&!(e instanceof RegExp)&&!(e instanceof ArrayBuffer)&&!(e instanceof Promise),M=g,k=(e,t,n,o)=>({deleteProperty(e,t){const s=Reflect.get(e,t);n(t);const r=Reflect.deleteProperty(e,t);return r&&o(["delete",[t],s]),r},set(r,a,i,c){const f=!e()&&Reflect.has(r,a),u=Reflect.get(r,a,c);if(f&&(x(u,i)||E.has(i)&&x(u,E.get(i))))return!0;var h;n(a),w(i)&&(i=l(h=i)&&h[s]||null||i);const p=!v.has(i)&&P(i)?D(i):i;return t(a,p),Reflect.set(r,a,p,c),o(["set",[a],i,u]),!0}});function D(e={}){if(!w(e))throw new Error("object required");const t=E.get(e);if(t)return t;let n=m[0];const s=new Set,o=(e,t=++m[0])=>{n!==t&&(n=t,s.forEach((n=>n(e,t))))};let r=m[1];const a=e=>(t,n)=>{const s=[...t];s[1]=[e,...s[1]],o(s,n)},i=new Map;let c=!0;const l=k((()=>c),((e,t)=>{const n=!O.has(t)&&v.get(t);if(n){if("undefined"!=typeof process&&process.env?process.env.NODE_ENV:i.has(e))throw new Error("prop listener already exists");if(s.size){const t=n[2](a(e));i.set(e,[n,t])}else i.set(e,[n])}}),(e=>{var t;const n=i.get(e);n&&(i.delete(e),null==(t=n[1])||t.call(n))}),o),f=j(e,l);E.set(e,f);const u=[e,(e=++m[1])=>(r===e||s.size||(r=e,i.forEach((([t])=>{const s=t[1](e);s>n&&(n=s)}))),n),e=>{s.add(e),1===s.size&&i.forEach((([e,t],n)=>{if("undefined"!=typeof process&&process.env?process.env.NODE_ENV:t)throw new Error("remove already exists");const s=e[2](a(n));i.set(n,[e,s])}));return()=>{s.delete(e),0===s.size&&i.forEach((([e,t],n)=>{t&&(t(),i.set(n,[e]))}))}}];return v.set(f,u),Reflect.ownKeys(e).forEach((t=>{const n=Object.getOwnPropertyDescriptor(e,t);"value"in n&&n.writable&&(f[t]=e[t])})),c=!1,f}function N(e,t,n){const s=v.get(e);let o;("undefined"!=typeof process&&process.env?process.env.NODE_ENV:!s)&&console.warn("Please use proxy object");const r=[],a=s[2];let i=!1;const c=a((e=>{r.push(e),n?t(r.splice(0)):o||(o=Promise.resolve().then((()=>{o=void 0,i&&t(r.splice(0))})))}));return i=!0,()=>{i=!1,c()}}function R(e){const t=v.get(e);("undefined"!=typeof process&&process.env?process.env.NODE_ENV:!t)&&console.warn("Please use proxy object");const[n,s]=t;return M(n,s())}function T(){return{proxyStateMap:v,refSet:O,snapCache:S,versionHolder:m,proxyCache:E}}const _=(e,n)=>{const s=t.useRef(void 0);t.useEffect((()=>{s.current=((e,t)=>{const n=[],s=new WeakSet,o=(e,r)=>{var i,c,l;if(s.has(e))return;f(e)&&s.add(e);const u=f(e)&&t.get(p(e));if(u){if(null===(i=u.h)||void 0===i||i.forEach((e=>{const t=`:has(${String(e)})`;n.push(r?[...r,t]:[t])})),!0===u[a]){const e=":ownKeys";n.push(r?[...r,e]:[e])}else null===(c=u.o)||void 0===c||c.forEach((e=>{const t=`:hasOwn(${String(e)})`;n.push(r?[...r,t]:[t])}));null===(l=u.k)||void 0===l||l.forEach((t=>{"value"in(Object.getOwnPropertyDescriptor(e,t)||{})&&o(e[t],r?[...r,t]:[t])}))}else r&&n.push(r)};return o(e),n})(e,n)})),t.useDebugValue(s.current)},A=new WeakMap;function C(e,n){const s=null==n?void 0:n.sync,o=t.useMemo((()=>e&&new WeakMap),[e]),r=t.useRef(void 0);let a=!0;const i=t.useSyncExternalStore(t.useCallback((t=>{const n=N(e,t,s);return t(),n}),[e,s]),(()=>{const t=R(e);try{if(!a&&r.current&&!y(r.current,t,o,new WeakMap))return r.current}catch(e){}return t}),(()=>R(e)));a=!1,t.useLayoutEffect((()=>{r.current=i})),"undefined"!=typeof process&&process.env&&!process.env.NODE_ENV||_(i,o);const c=t.useMemo((()=>new WeakMap),[]);return d(i,o,c,A)}let z;const W=Symbol();const{proxyStateMap:I,snapCache:V}=T(),J=e=>I.has(e);function K(e){const t=[];let n=0;const s=new Map,o=new WeakMap,r=e=>o.get(e)||s;if(e){if("function"!=typeof e[Symbol.iterator])throw new TypeError("proxyMap:\n\tinitial state must be iterable\n\t\ttip: structure should be [[key, value]]");for(const[o,r]of e)s.set(o,n),t[n++]=r}const a={data:t,index:n,epoch:0,get size(){J(this)||(()=>{const e=V.get(a),t=null==e?void 0:e[1];if(t&&!o.has(t)){const e=new Map(s);o.set(t,e)}})();return r(this).size},get(e){const t=r(this).get(e);if(void 0!==t)return this.data[t];this.epoch},has(e){const t=r(this);return this.epoch,t.has(e)},set(e,t){if(!J(this))throw new Error("Cannot perform mutations on a snapshot");const n=s.get(e);return void 0===n?(s.set(e,this.index),this.data[this.index++]=t):this.data[n]=t,this.epoch++,this},delete(e){if(!J(this))throw new Error("Cannot perform mutations on a snapshot");const t=s.get(e);return void 0!==t&&(delete this.data[t],s.delete(e),this.epoch++,!0)},clear(){if(!J(this))throw new Error("Cannot perform mutations on a snapshot");this.data.length=0,this.index=0,this.epoch++,s.clear()},forEach(e){this.epoch;r(this).forEach(((t,n)=>{e(this.data[t],n,this)}))},*entries(){this.epoch;const e=r(this);for(const[t,n]of e)yield[t,this.data[n]]},*keys(){this.epoch;const e=r(this);for(const t of e.keys())yield t},*values(){this.epoch;const e=r(this);for(const t of e.values())yield this.data[t]},[Symbol.iterator](){return this.entries()},get[Symbol.toStringTag](){return"Map"},toJSON(){return new Map(this.entries())}},i=D(a);return Object.defineProperties(i,{size:{enumerable:!1},index:{enumerable:!1},epoch:{enumerable:!1},data:{enumerable:!1},toJSON:{enumerable:!1}}),Object.seal(i),i}const{proxyStateMap:L,snapCache:H}=T(),$=e=>"object"==typeof e?D({x:e}).x:e,U=e=>L.has(e);function q(e){const t=[],n=new Map;let s=0;const o=new WeakMap,r=e=>o.get(e)||n;if(e){if("function"!=typeof e[Symbol.iterator])throw new TypeError("not iterable");for(const o of e)if(!n.has(o)){const e=$(o);n.set(e,s),t[s++]=e}}const a={data:t,index:s,epoch:0,get size(){return U(this)||(()=>{const e=H.get(a),t=null==e?void 0:e[1];if(t&&!o.has(t)){const e=new Map(n);o.set(t,e)}})(),n.size},has(e){const t=r(this),n=$(e);return this.epoch,t.has(n)},add(e){if(!U(this))throw new Error("Cannot perform mutations on a snapshot");const t=$(e);return n.has(t)||(n.set(t,this.index),this.data[this.index++]=t,this.epoch++),this},delete(e){if(!U(this))throw new Error("Cannot perform mutations on a snapshot");const t=$(e),s=n.get(t);return void 0!==s&&(delete this.data[s],n.delete(t),this.epoch++,!0)},clear(){if(!U(this))throw new Error("Cannot perform mutations on a snapshot");this.data.length=0,this.index=0,this.epoch++,n.clear()},forEach(e){this.epoch;r(this).forEach((t=>{e(this.data[t],this.data[t],this)}))},*values(){this.epoch;const e=r(this);for(const t of e.values())yield this.data[t]},keys(){return this.epoch,this.values()},*entries(){this.epoch;const e=r(this);for(const t of e.values()){const e=this.data[t];yield[e,e]}},toJSON(){return new Set(this.values())},[Symbol.iterator](){return this.values()},get[Symbol.toStringTag](){return"Set"},intersection(e){this.epoch;const t=q(e),n=q();for(const e of this.values())t.has(e)&&n.add(e);return q(n)},union(e){this.epoch;const t=q(),n=q(e);for(const e of this.values())t.add(e);for(const e of n)t.add(e);return q(t)},difference(e){this.epoch;const t=q(),n=q(e);for(const e of this.values())n.has(e)||t.add(e);return q(t)},symmetricDifference(e){this.epoch;const t=q(),n=q(e);for(const e of this.values())n.has(e)||t.add(e);for(const e of n.values())this.has(e)||t.add(e);return q(t)},isSubsetOf(e){this.epoch;const t=q(e);return this.size<=e.size&&[...this.values()].every((e=>t.has(e)))},isSupersetOf(e){this.epoch;const t=q(e);return this.size>=e.size&&[...t].every((e=>this.has(e)))},isDisjointFrom(e){this.epoch;const t=q(e);return[...this.values()].every((e=>!t.has(e)))}},i=D(a);return Object.defineProperties(i,{size:{enumerable:!1},data:{enumerable:!1},index:{enumerable:!1},epoch:{enumerable:!1},toJSON:{enumerable:!1}}),Object.seal(i),i}let B;const F=()=>(B||(B=T().refSet),B);const X=Symbol();e.deepClone=function e(t,n=F){if("object"!=typeof(s=t)||null===s||n().has(t))return t;var s;if((e=>Symbol.toStringTag in e&&"Set"===e[Symbol.toStringTag]&&L.has(e))(t))return q([...t]);if((e=>Symbol.toStringTag in e&&"Map"===e[Symbol.toStringTag]&&I.has(e))(t))return K([...t.entries()]);const o=Array.isArray(t)?[]:Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach((s=>{o[s]=e(t[s],n)})),o},e.devtools=function(e,t){const{enabled:n,name:s="",...o}=t||{};let r;try{r=(null!=n?n:"undefined"==typeof process||!process.env||process.env.NODE_ENV)&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(!r)return void(("undefined"!=typeof process&&process.env?process.env.NODE_ENV:n)&&console.warn("[Warning] Please install/enable Redux devtools extension"));let a=!1;const i=r.connect({name:s,...o}),c=N(e,(t=>{const n=t.filter((([e,t])=>t[0]!==W)).map((([e,t])=>`${e}:${t.map(String).join(".")}`)).join(", ");if(n)if(a)a=!1;else{const t=Object.assign({},R(e));delete t[W],i.send({type:n,updatedAt:(new Date).toLocaleString()},t)}})),l=i.subscribe((t=>{var n,s,o,r,c,l;if("ACTION"===t.type&&t.payload)try{Object.assign(e,JSON.parse(t.payload))}catch(e){console.error("please dispatch a serializable value that JSON.parse() and proxy() support\n",e)}if("DISPATCH"===t.type&&t.state){if("JUMP_TO_ACTION"===(null==(n=t.payload)?void 0:n.type)||"JUMP_TO_STATE"===(null==(s=t.payload)?void 0:s.type)){a=!0;const n=JSON.parse(t.state);Object.assign(e,n)}e[W]=t}else if("DISPATCH"===t.type&&"COMMIT"===(null==(o=t.payload)?void 0:o.type))i.init(R(e));else if("DISPATCH"===t.type&&"IMPORT_STATE"===(null==(r=t.payload)?void 0:r.type)){const n=null==(c=t.payload.nextLiftedState)?void 0:c.actionsById,s=(null==(l=t.payload.nextLiftedState)?void 0:l.computedStates)||[];a=!0,s.forEach((({state:t},s)=>{const o=n[s]||"No action found";Object.assign(e,t),0===s?i.init(R(e)):i.send(o,R(e))}))}}));return i.init(R(e)),()=>{c(),null==l||l()}},e.getVersion=function(e){const t=v.get(e);return null==t?void 0:t[1]()},e.proxy=D,e.proxyMap=K,e.proxySet=q,e.ref=function(e){return O.add(e),e},e.snapshot=R,e.subscribe=N,e.subscribeKey=function(e,t,n,s){let o=e[t];return N(e,(()=>{const s=e[t];Object.is(o,s)||n(o=s)}),s)},e.unstable_getInternalStates=T,e.unstable_replaceInternalFunction=function(e,t){switch(e){case"objectIs":x=t(x);break;case"newProxy":j=t(j);break;case"canProxy":P=t(P);break;case"createSnapshot":M=t(M);break;case"createHandler":k=t(k);break;default:throw new Error("unknown function")}},e.useProxy=function(e,n){const s=C(e,n);s[X];let o=!0;return t.useLayoutEffect((()=>{o=!1})),new Proxy(e,{get:(e,t)=>o?s[t]:e[t]})},e.useSnapshot=C,e.watch=function(e,t){let n=!0;const s=new Set,o=new Map,r=()=>{n&&(n=!1,s.forEach((e=>e())),s.clear(),o.forEach((e=>e())),o.clear())},a=async()=>{if(!n)return;s.forEach((e=>e())),s.clear();const i=new Set,c=z;z=s;try{const c=e((e=>{if(i.add(e),n&&!o.has(e)){const n=N(e,a,null==t?void 0:t.sync);o.set(e,n)}return e})),l=c&&c instanceof Promise?await c:c;l&&(n?s.add(l):r())}finally{z=c}o.forEach(((e,t)=>{i.has(t)||(o.delete(t),e())}))};return z&&z.add(r),a(),r}}));